var page={init:function(){this.$body=$(document.body),this.$mapData=$("#map-data"),this.$mapTip=$(".search-tip"),this.$searchBoxInput=$("#search_box_input"),this.$searchBtn=$(".search-icon"),this.$picker=$(".picker"),this.$pickerPosition=$(".picker-address"),this.count=0,this.labelArray=[],this.mapRenderResult=[],this.addEventListener(),this.locate(),this.initSwiper()},initSwiper:function(){var t=new Swiper(".swiper-container",{mode:"horizontal",speed:300,slidesPerView:"auto",centeredSlides:!0,grabCursor:!0,initialSlide:5});$(".switch-left").on("click",function(i){i.preventDefault(),t.swipePrev()}),$(".switch-right").on("click",function(i){i.preventDefault(),t.activeIndex!==t.slides.length-1&&t.swipeNext()})},initCanvasLabel:function(t,i){if(this.labelArray&&0!==this.labelArray.length){this.labelArray.length<t&&(this.canvaslabel.drawImg(this.labelArray.length,t),this.labelArray=this.canvaslabel.urlArray);for(var e=0;e<i.length;e++)this.addMarker(this.map,i[e],e)}else this.canvaslabel=new CanvasLabel({imgUrl:"https://wwwstatic.vivo.com.cn/vivoportal/web/dist/img/store/position-mark-map_d08714a.png",num:t,callback:function(t){this.labelArray=t;for(var e=0;e<i.length;e++)this.addMarker(this.map,i[e],e)}.bind(this)})},addMarker:function(t,i,e){var s=new BMap.Point(i.longitude,i.latitude),n=new BMap.Icon(this.labelArray[e],new BMap.Size(22,28),{imageSize:new BMap.Size(22,28)}),a=new BMap.Marker(s,{icon:n});i.marker=a,t.addOverlay(a);var o={width:200,height:100,title:i.storeName},r=new BMap.InfoWindow("地址："+i.address+"<br/>联系电话："+i.phone,o);return a.addEventListener("click",function(){t.openInfoWindow(r,s)}),this},locate:function(){this.map=new BMap.Map("map-box"),this.map.enableScrollWheelZoom(!0);var t=new BMap.NavigationControl;this.map.addControl(t),this.geolocation=new BMap.Geolocation,this.geolocation.getCurrentPosition(function(t){this.geolocation.getStatus()===BMAP_STATUS_SUCCESS?(this.position=t.point,this.lat=this.position.lat,this.lng=this.position.lng,(new BMap.Geocoder).getLocation(this.position,function(t){this.province=t.addressComponents.province,this.city=t.addressComponents.city,this.area=t.addressComponents.district,this.city=this.province===this.city?this.area:this.city,this.$pickerPosition.text(this.province+" "+this.city),this.initPicker()}.bind(this))):$.ajax({url:"/portal/open/api/location",type:"post"}).done(function(t,i){"success"===i&&200===t.retCode&&t.data&&t.data.province&&t.data.city&&(this.province=t.data.province,this.city=t.data.city)}.bind(this)).always(function(){this.initPicker()}.bind(this))}.bind(this),{enableHighAccuracy:!0,timeout:5e3,maximumAge:0})},initPicker:function(){this.cityPicker=new PCPickerCity({picker:"#pc-picker",province:this.province,city:this.city,callback:function(t,i){this.cityList=this.cityPicker.addressList,this.onlyCityFlag=1,this.count++,this.$mapTip.hide(),$("#pc-picker").slideUp(),this.province||this.$mapTip.text("定位失败，以下为推荐结果").show(),1===this.count&&this.province&&(this.onlyCityFlag=0),this.province=t||this.position,this.city=i||this.city,this.$pickerPosition.text(this.province===this.city?this.province:this.province+" "+this.city),this.$pickerPosition.removeClass("picker-address-active"),this.query()}.bind(this)})},query:function(){var t={};t=0===this.onlyCityFlag?{province:this.province,city:this.province===this.city?"":this.city,searchType:3,latitude:this.lat,longitude:this.lng,radius:3e4}:this.position?{province:this.province,city:this.city,searchType:1,latitude:this.lat,longitude:this.lng}:{province:this.province,city:this.province===this.city?"":this.city,searchType:1},$.ajax({url:"/store/shops",type:"post",data:t}).done(function(t,i){if("success"===i){var e=t.data.stores;e&&e.length?(this.mapResult=e,this.render(this.mapResult)):(this.$mapTip.text("附近暂无体验店，以下为推荐结果").show(),this.queryCity("北京市",""))}}.bind(this))},queryCity:function(t,i){var e={};e=this.position?{province:t,city:i,searchType:1,latitude:this.lat,longitude:this.lng}:{province:t,city:i,searchType:1},$.ajax({url:"/store/shops",type:"post",data:e}).done(function(t,i){if("success"===i){var e=t.data.stores;e&&e.length&&(this.mapResult=e,this.render(this.mapResult))}}.bind(this))},render:function(t){var i;$(".store-no-more").remove(),$(".store-list").remove(),this.map.clearOverlays(),this.initCanvasLabel(t.length,t),this.map.centerAndZoom(new BMap.Point(t[0].longitude,t[0].latitude),12),this.mapRenderResult=t,t.forEach(function(t,e){i=this.position?"//api.map.baidu.com/direction?origin=latlng:"+this.position.lat+","+this.position.lng+"|name:"+encodeURIComponent("我的位置")+"&origin_region="+encodeURIComponent(this.city)+"&destination_region=undefined&destination=name:"+encodeURIComponent(t.address)+"|latlng:"+t.latitude+","+t.longitude+"&mode=driving&output=html&src=yourCompanyName|yourAppName":"//api.map.baidu.com/marker?location="+t.latitude+","+t.longitude+"&title="+encodeURIComponent(t.storeName)+"&content="+encodeURIComponent(t.address)+"&output=html&src";var s='<div class="store-list" data-pos="'+(e+1)+'">\n          <p class="store-name">'+t.storeName+'</p>\n          <p class="store-address">'+t.address+'</p>\n          <span class="store-phone">'+t.phone+"</span>\n";s+=t.distance&&t.distance<1e5?'<span class="store-distance">'+(t.distance/1e3).toFixed(2)+"km</span>\n":"",s+='<a class="store-navigation" href="'+i+'" target="_blank" data-track=\'{"type":"click","params":{"version":"1.5.0","pageview":"官网体验店主页","cfrom":"6602","id":"'+t.storeId+'","name":"'+t.storeName+"\"}}'>导航</a></div>",this.$mapData.append($(s))},this);var e=$('<p class="store-no-more">所选地区已无更多结果</p>');this.$mapData.append(e)},searchStores:function(){var t=this.$searchBoxInput.val().trim();if(this.$mapTip.hide(),t){var i=[];this.mapResult.forEach(function(e){(e.storeName.indexOf(t)>-1||e.address.indexOf(t)>-1||e.phone.indexOf(t)>-1)&&i.push(e)}),i.length?this.render(i):($(".store-no-more").remove(),$(".store-list").remove(),this.map.clearOverlays(),this.$mapTip.text('暂无匹配"'+t+'"的结果').show(),this.map.centerAndZoom(this.city,15))}else this.render(this.mapResult)},debounce:function(t,i){var e;return function(){var s=this,n=arguments;clearTimeout(e),e=setTimeout(function(){t.apply(s,n)},i)}},addEventListener:function(){var t;this.$mapData.on("click",".store-list",function(t){$(".store-list").removeClass("store-list-active"),$(t.currentTarget).addClass("store-list-active");var i=$(t.currentTarget).attr("data-pos")-1;this.mapRenderResult.forEach(function(t){t.marker.setAnimation(null)}),this.mapRenderResult[i].marker.setAnimation(BMAP_ANIMATION_BOUNCE),this.point=new BMap.Point(this.mapRenderResult[i].longitude,this.mapRenderResult[i].latitude),this.map.centerAndZoom(this.point,18)}.bind(this)),this.$pickerPosition.on("click",function(){var t=$("#pc-picker");this.$pickerPosition.hasClass("picker-address-active")?(t.slideUp(),this.$pickerPosition.removeClass("picker-address-active")):(t.slideDown(),this.$pickerPosition.addClass("picker-address-active"))}.bind(this)),this.$searchBtn.on("click",function(){this.searchStores()}.bind(this)),this.$searchBoxInput.on("input propertychange",function(){setTimeout(function(){t||this.debounce(this.searchStores(),600)}.bind(this),0)}.bind(this)).on("compositionstart",function(){t=!0}).on("compositionend",function(){t=!1}).on("keyup",function(i){(46===i.which||8===i.which)&&setTimeout(function(){t||this.debounce(this.searchStores(),600)}.bind(this),0)}.bind(this))}};page.init();